<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KTV TVç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    /* TV å°ˆç”¨æ¨£å¼å„ªåŒ– */
    body {
      font-family: Roboto, "Noto Sans TC", sans-serif;
      background-color: #121212; color: #e0e0e0;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      overflow-x: hidden;
    }
    .container { width: 100%; max-width: 1000px; padding-bottom: 50px; }
    
    #video-wrapper {
      position: relative; width: 100%; padding-top: 56.25%; /* 16:9 */
      background: #000; border: 2px solid #333; border-radius: 12px; 
      overflow: hidden; margin-bottom: 20px;
    }
    /* é™æ§å™¨é¸ä¸­å½±ç‰‡æ™‚è¦æœ‰é‚Šæ¡†æç¤º */
    #video-wrapper:focus-within { border-color: #03dac6; box-shadow: 0 0 15px rgba(3, 218, 198, 0.5); }
    
    video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; outline: none; }

    .control-panel {
      background: #1e1e1e; padding: 20px; border-radius: 16px; margin-bottom: 20px;
    }
    .btn-row { display: flex; gap: 15px; justify-content: center; margin-bottom: 15px; }
    
    /* åŠ å¤§æŒ‰éˆ•ï¼Œå¢åŠ  Focus æ¨£å¼ */
    button {
      padding: 15px 30px; border-radius: 8px; border: 2px solid transparent; cursor: pointer;
      font-size: 1.2rem; font-weight: bold; transition: all 0.2s;
      outline: none; /* ç§»é™¤é è¨­ outlineï¼Œç”¨è‡ªå®šç¾© border */
    }
    button:focus {
      border-color: #fff;
      transform: scale(1.05);
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }
    
    .btn-play { background: #03dac6; color: #000; flex: 2; }
    .btn-vocal { background: #333; color: #fff; border: 2px solid #555; flex: 1; }
    .btn-vocal.active { background: #cf6679; color: #000; border-color: #cf6679; }
    
    .input-group {
      background: #2c2c2c; padding: 15px; border-radius: 12px; margin-bottom: 15px;
    }
    .input-label { display: block; color: #aaa; font-size: 1rem; margin-bottom: 8px; }
    /* è®“ file input æ›´å®¹æ˜“è¢«é™æ§å™¨é¸ä¸­ */
    input[type="file"] { 
      width: 100%; color: #fff; font-size: 1rem; padding: 10px; 
      background: #333; border-radius: 4px; outline: none;
    }
    input[type="file"]:focus { background: #444; border: 2px solid #03dac6; }

    #playlist { list-style: none; padding: 0; margin: 0; }
    .playlist-item {
      background: #252525; margin-bottom: 10px; padding: 15px; border-radius: 12px;
      display: flex; justify-content: space-between; align-items: center;
      border: 2px solid transparent;
    }
    /* é™æ§å™¨é¸ä¸­æ¸…å–®é …ç›® */
    .playlist-item:focus, .playlist-item:hover {
      background: #333; border-color: #03dac6;
    }
    .playlist-item.playing { background: #2a2a2a; border-left: 8px solid #03dac6; }
    
    .item-info { flex-grow: 1; overflow: hidden; }
    .item-title { display: block; font-size: 1.1rem; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-match-info { font-size: 0.9rem; color: #aaa; margin-top: 6px; }
    .match-success { color: #4caf50; }
    .match-none { color: #ff9800; }
    
    .btn-del { 
      background: #444; color: #fff; font-size: 1.2rem; padding: 8px 15px; margin-left: 10px;
    }
    .btn-del:focus { background: #cf6679; }

  </style>
</head>
<body>

<div class="container">
  <h2 style="text-align: center; color: #bb86fc; margin: 10px 0;">KTV å®¶åº­åŠ‡é™¢ç‰ˆ</h2>

  <div id="video-wrapper">
    <video id="mainVideo" controls playsinline webkit-playsinline tabindex="1"></video>
  </div>
  <audio id="extAudio"></audio>

  <div class="control-panel">
    <div class="btn-row">
      <button id="playBtn" class="btn-play" tabindex="2">â–¶ æ’­æ”¾ / æš«åœ</button>
      <button id="vocalBtn" class="btn-vocal" tabindex="3">å»äººè²</button>
    </div>
    <div style="text-align: center; color: #888; font-size: 1rem;" id="status-text">
      è«‹ä½¿ç”¨é™æ§å™¨é¸æ“‡ä¸‹æ–¹æŒ‰éˆ•åŒ¯å…¥æ­Œæ›²
    </div>
  </div>

  <!-- æ‰¹æ¬¡åŒ¯å…¥å€ -->
  <div class="control-panel">
    <h3 style="margin: 0 0 15px 0; font-size: 1.1rem; color: #fff;">ğŸ“‚ åŒ¯å…¥æ­Œæ›² (æ”¯æ´ USB æª”æ¡ˆ)</h3>
    
    <div class="input-group">
      <span class="input-label">1. é¸æ“‡å½±ç‰‡æª” (MP4)</span>
      <input type="file" id="videoInput" accept="video/*" multiple tabindex="4">
    </div>
    
    <div class="input-group">
      <span class="input-label">2. é¸æ“‡éŸ³è¨Šæª” (MP3) [é¸å¡«]</span>
      <input type="file" id="audioInput" accept="audio/*" multiple tabindex="5">
    </div>

    <button onclick="batchImport()" style="width: 100%; background: #444; color: white;" tabindex="6">é–‹å§‹é…å°ä¸¦åŠ å…¥æ¸…å–®</button>
  </div>

  <ul id="playlist" tabindex="7"></ul>
</div>

<script>
  // ... (JavaScript é‚è¼¯èˆ‡ ktv-smart-match.html å®Œå…¨ç›¸åŒï¼Œç›´æ¥è¤‡è£½éä¾†å³å¯) ...
  // ç‚ºäº†ç¯‡å¹…ï¼Œæˆ‘åªåˆ—å‡ºéœ€è¦ç‰¹åˆ¥é‡å° TV ä¿®æ”¹çš„ JS éƒ¨åˆ†ï¼š
  
  // å¢åŠ éµç›¤ç›£è½ (é‡å°é™æ§å™¨ OK éµ)
  document.addEventListener('keydown', (e) => {
    // é™æ§å™¨ OK éµé€šå¸¸å°æ‡‰ Enter (13) æˆ– Center (23)
    if (e.keyCode === 13 || e.keyCode === 23) {
      // å¦‚æœç•¶å‰ focus åœ¨æ¸…å–®é …ç›®ä¸Šï¼Œè§¸ç™¼é»æ“Šæ’­æ”¾
      if (document.activeElement.classList.contains('playlist-item')) {
        document.activeElement.click();
      }
    }
  });

  // ä¸‹é¢è«‹è²¼ä¸Šå®Œæ•´çš„ JavaScript ç¨‹å¼ç¢¼ (åŒ ktv-smart-match.html)
  // ... (JS Code Start) ...
  
  const mainVideo = document.getElementById('mainVideo');
  const extAudio = document.getElementById('extAudio');
  const playBtn = document.getElementById('playBtn');
  const vocalBtn = document.getElementById('vocalBtn');
  const statusText = document.getElementById('status-text');
  const playlistEl = document.getElementById('playlist');
  const videoInput = document.getElementById('videoInput');
  const audioInput = document.getElementById('audioInput');

  let playlist = [];
  let currentIndex = -1;
  let isPlaying = false;
  let isVocalRemove = false;
  let syncInterval;
  let audioCtx, sourceNode, splitter, merger, inverter;

  function initAudio() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }

  function setupAudioRouting() {
    initAudio();
    if (sourceNode) sourceNode.disconnect();
    else sourceNode = audioCtx.createMediaElementSource(extAudio);

    if (isVocalRemove) {
      if (!splitter) splitter = audioCtx.createChannelSplitter(2);
      if (!merger) merger = audioCtx.createChannelMerger(2);
      if (!inverter) { inverter = audioCtx.createGain(); inverter.gain.value = -1; }

      sourceNode.connect(splitter);
      splitter.connect(merger, 0, 0);
      splitter.connect(inverter, 1);
      inverter.connect(merger, 0, 0);
      splitter.connect(merger, 0, 1);
      inverter.connect(merger, 0, 1);

      merger.connect(audioCtx.destination);
    } else {
      sourceNode.connect(audioCtx.destination);
    }
  }

  playBtn.addEventListener('click', () => {
    if (currentIndex === -1) return alert("æ¸…å–®æ˜¯ç©ºçš„ï¼");
    if (mainVideo.paused) mainVideo.play();
    else mainVideo.pause();
  });

  mainVideo.addEventListener('play', () => {
    initAudio();
    extAudio.play();
    isPlaying = true;
    playBtn.textContent = "â¸ æš«åœ";
    startSync();
    setupAudioRouting();
  });

  mainVideo.addEventListener('pause', () => {
    extAudio.pause();
    isPlaying = false;
    playBtn.textContent = "â–¶ æ’­æ”¾";
    stopSync();
  });

  mainVideo.addEventListener('seeked', () => {
    extAudio.currentTime = mainVideo.currentTime;
    if (!mainVideo.paused) extAudio.play();
  });

  function startSync() {
    stopSync();
    syncInterval = setInterval(() => {
      if (mainVideo.paused) return;
      const diff = Math.abs(mainVideo.currentTime - extAudio.currentTime);
      if (diff > 0.2) extAudio.currentTime = mainVideo.currentTime;
    }, 500);
  }

  function stopSync() {
    if (syncInterval) clearInterval(syncInterval);
  }

  function getFileName(file) {
    return file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
  }

  function batchImport() {
    const vFiles = Array.from(videoInput.files);
    const aFiles = Array.from(audioInput.files);

    if (vFiles.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡å½±ç‰‡æª”ï¼");

    const audioMap = new Map();
    aFiles.forEach(f => audioMap.set(getFileName(f), f));

    let addedCount = 0;
    vFiles.forEach(vFile => {
      const baseName = getFileName(vFile);
      const matchedAudio = audioMap.get(baseName);
      const audioSource = matchedAudio ? matchedAudio : vFile;
      
      playlist.push({
        title: baseName,
        videoUrl: URL.createObjectURL(vFile),
        audioUrl: URL.createObjectURL(audioSource),
        isMatch: !!matchedAudio
      });
      addedCount++;
    });

    renderPlaylist();
    videoInput.value = '';
    audioInput.value = '';

    if (addedCount > 0) {
      if (currentIndex === -1) playIndex(0);
    }
  }

  function renderPlaylist() {
    playlistEl.innerHTML = '';
    playlist.forEach((item, idx) => {
      const li = document.createElement('li');
      li.className = `playlist-item ${idx === currentIndex ? 'playing' : ''}`;
      li.tabIndex = 10 + idx; // è®“é™æ§å™¨å¯ä»¥ focus åˆ°æ¯å€‹é …ç›®
      
      const matchText = item.isMatch 
        ? `<span class="item-match-info match-success">â˜… é…å°æˆåŠŸ</span>`
        : `<span class="item-match-info match-none">åŸéŸ³æ’­æ”¾</span>`;

      li.innerHTML = `
        <div class="item-info" onclick="playIndex(${idx})">
          <span class="item-title">${idx+1}. ${item.title}</span>
          ${matchText}
        </div>
        <button class="btn-del" onclick="delIndex(${idx})">Ã—</button>
      `;
      
      // å¢åŠ é»æ“Šäº‹ä»¶ç›£è½ (é‡å°é™æ§å™¨ OK éµ)
      li.addEventListener('click', (e) => {
        // é¿å…é»åˆ°åˆªé™¤æŒ‰éˆ•ä¹Ÿè§¸ç™¼æ’­æ”¾
        if (!e.target.classList.contains('btn-del')) {
           playIndex(idx);
        }
      });

      playlistEl.appendChild(li);
    });
  }

  function playIndex(idx) {
    if (idx < 0 || idx >= playlist.length) return;
    currentIndex = idx;
    const item = playlist[idx];

    mainVideo.src = item.videoUrl;
    extAudio.src = item.audioUrl;
    mainVideo.muted = true;

    statusText.textContent = `æ­£åœ¨æ’­æ”¾: ${item.title}`;
    mainVideo.play().catch(e => console.log(e));
    renderPlaylist();
  }

  function delIndex(idx) {
    playlist.splice(idx, 1);
    if (currentIndex === idx) {
      mainVideo.pause();
      currentIndex = -1;
      statusText.textContent = "åœæ­¢æ’­æ”¾";
    } else if (currentIndex > idx) currentIndex--;
    renderPlaylist();
  }

  vocalBtn.addEventListener('click', () => {
    isVocalRemove = !isVocalRemove;
    vocalBtn.classList.toggle('active');
    if (currentIndex !== -1) setupAudioRouting();
  });

  mainVideo.addEventListener('ended', () => {
    if (currentIndex < playlist.length - 1) playIndex(currentIndex + 1);
  });
  
  // ... (JS Code End) ...

</script>
</body>
</html>
